<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System</title>
</head>
    <style>
    body {
    font-family: Arial, sans-serif;
    margin: 0;
    background-color: #003c4a;
    color: #ffffff;
}

.pos-container {
    width: 100%;
    display: flex;
    flex-direction: column;
}

.pos-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #005a70;
    padding: 10px 20px;
    color: #ffffff;
}

.header-buttons .header-btn {
    background-color: #028090;
    color: #fff;
    border: none;
    padding: 8px 12px;
    margin-left: 10px;
    cursor: pointer;
    border-radius: 4px;
}

.header-btn.add-btn {
    font-size: 20px;
    font-weight: bold;
}

.pos-main {
    display: flex;
    gap: 20px;
    padding: 20px;
}

.categories {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.categories button {
    background-color: #007a8a;
    border: none;
    padding: 10px;
    color: #fff;
    border-radius: 4px;
    cursor: pointer;
}

.products {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    background-color: #002f3a;
    padding: 15px;
    border-radius: 8px;
    flex-grow: 2;
}

.product {
    background-color: #005a70;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    width: 120px;
}

.product img {
    width: 100%;
    border-radius: 4px;
}

.cart {
    width: 300px;
    background-color: #005a70;
    padding: 15px;
    border-radius: 8px;
}

.cart table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
}

.cart table th, .cart table td {
    text-align: left;
    padding: 5px;
    border-bottom: 1px solid #007a8a;
}

.cart-summary p {
    margin: 5px 0;
}

.cart-actions button {
    background-color: #007a8a;
    border: none;
    padding: 10px;
    color: #fff;
    margin: 5px 0;
    width: 100%;
    border-radius: 4px;
    cursor: pointer;
}

.payment-btn {
    background-color: #00b09b;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 10px;
}

.image-container {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid #028090;
}

.image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

    .category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            flex-direction: row;
        }
    .categories-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px; /* Space between category items */
        justify-content: center; /* Center the items */
        padding: 10px;
    }

    .category-item {
        background-color: greenyellow; /* Light gray background */
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px 20px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s ease, background-color 0.2s ease;
    }

    .category-item:hover {
        background-color: darkgreen; /* Slightly darker gray on hover */
        transform: scale(1.05); /* Slight zoom on hover */
    }

    .products {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        padding: 20px;
    }

    .product {
        width: 150px;
        border: #005a70;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        background-color: #005a70;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .product:hover {
        transform: scale(1.05);
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    }

    .product img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .product p {
        margin: 5px 0;
    }

    .product p:nth-child(2) {
        font-weight: bold;
    }

    .product p:nth-child(3) {
        color: #28a745;
        font-weight: bold;
    }

    .categories {
        display: flex;
        gap: 10px;
        margin: 20px;
    }

    .category {
        padding: 10px 15px;
        background-color: greenyellow;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .category:hover {
        background-color: darkgreen;
    }

    .add-to-cart {
    background-color: #28a745; /* Green background */
    color: white; /* White text */
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.add-to-cart:hover {
    background-color: #218838; /* Darker green on hover */
    transform: scale(1.05); /* Slight grow effect */
}

.add-to-cart:focus {
    outline: none; /* Remove default outline */
}

.add-to-cart:active {
    background-color: #1e7e34; /* Even darker green when clicked */
    transform: scale(0.98); /* Slight shrink effect on click */
}

.out-of-stock {
    background-color: lightcoral; /* Even darker green when clicked */
    transform: scale(0.98); /* Slight shrink effect on click */
}

.out-of-stock:hover {
    background-color: darkred; /* Even darker green when clicked */
    transform: scale(0.98); /* Slight shrink effect on click */
}

/* Warning Modal Styling (Bootstrap-like look) */
.modal {
    display: none;
    position: fixed; /* Use fixed positioning */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
    justify-content: center; /* Center the modal */
    align-items: center; /* Vertically center the modal */
    z-index: 1000; /* Ensure the modal is on top of other elements */
}

.modal-dialog {
    max-width: 500px;
    width: 100%;
}

.modal-content {
    background-color: yellow;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    padding: 20px;
}

.modal-header {
    background-color: yellow;
    color: #721c24;
    border-bottom: 1px solid #ddd;
    padding: 10px;
}

.modal-body {
    background-color: yellow;
    color: #721c24;
    padding: 20px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    padding: 10px;
}

.close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #721c24;
}

.btn-secondary {
    background-color: #007bff;
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-secondary:hover {
    background-color: #0056b3;
}


/* Success Modal Styling (Bootstrap-like look) */
.modal1 {
    display: none;
    position: fixed; /* Use fixed positioning */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
    justify-content: center; /* Center the modal */
    align-items: center; /* Vertically center the modal */
    z-index: 1000; /* Ensure the modal is on top of other elements */
}

.modal-dialog1 {
    max-width: 500px;
    width: 100%;
}

.modal-content1 {
    background-color: greenyellow;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    padding: 20px;
}

.modal-header1 {
    background-color: greenyellow;
    color: white;
    border-bottom: 1px solid #ddd;
    padding: 10px;
}

.modal-body1 {
    background-color: greenyellow;
    color: white;
    padding: 20px;
}

.modal-footer1 {
    display: flex;
    justify-content: flex-end;
    padding: 10px;
}

.close1 {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: grey;
}

.btn-secondary1 {
    background-color: #007bff;
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-secondary1:hover {
    background-color: #0056b3;
}


</style>
<body>
    <div class="pos-container">
        <!-- Header Section -->
        <header class="pos-header">
            <h1>ST3.4 POS System</h1>
            <div class="header-right">
                 <div class="image-container">
                    <img src="{{ user_profile_image }}" alt="User Profile Image">
                </div>
                <button class="header-btn">{{username}}</button>
                <a href="/logout" style="background-color: lightcoral;
                                        color: #fff;
                                        border: none;
                                        padding: 8px 12px;
                                        margin-left: 10px;
                                        cursor: pointer;
                                        border-radius: 4px;">
                    Logout</a>

            </div>
        </header>


        <!-- Main Section -->
        <main class="pos-main">
            <section id="categories-section">
            <h2>Categories</h2>
            <div id="categories-container" class="categories-row">
                <!-- Categories will be dynamically loaded here -->

            </div>
        </section>

            <!-- Product List -->
            <div class="products" >
                <div class="products" id="products-container"></div>
                <!-- Add more product cards as needed -->
            </div>

            <!-- Cart Section -->
            <div class="cart">
               <div id="cart-container">
                    <h3>Cart</h3>
                    <table id="cart-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="cart-items">
                            <!-- Cart items will be dynamically added here -->
                        </tbody>
                    </table>
                    <p>Total: $<span id="cart-total">0.00</span></p>
                </div>
                Payment amount :
                <input type="text" id="payment-amount" required>
                <div>Change :</div>
                <input type="text" id="change" readonly required>
                <div class="cart-actions">
                    <form onsubmit="event.preventDefault(); placeOrder();">
                        <input type="hidden" id="product_id" placeholder="Product ID" required />
                        <input type="hidden" id="quantity" placeholder="Quantity" required />
                        <input type="hidden" value="{{username}}" id="customer_name" placeholder="Customer Name" required />
                        <input type="hidden" value="{{email}}" id="customer_email" placeholder="Customer Email" required />
                        <button type="submit" id="pay-btn" class="payment-btn" disabled>Place Order</button>
                    </form>
                </div>
            </div>
        </main>
    </div>
<!-- Warning Modal (Hidden by default) -->
<div class="modal" tabindex="-1" role="dialog" id="warningModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Not enough stock</h5>
      </div>
      <div class="modal-body">
        <p>The quantity of the products you order exceed the amount of stock.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Warning Modal (Hidden by default) -->
<div class="modal1" tabindex="-1" role="dialog" id="successModal">
  <div class="modal-dialog1" role="document">
    <div class="modal-content1">
      <div class="modal-header1">
        <h5 class="modal-title1">Thanks for purchasing!</h5>
      </div>
      <div class="modal-body1">
        <p>We will have a lot of new products in the near future.</p>
      </div>
      <div class="modal-footer1">
        <button type="button" class="btn btn-secondary1" onclick="successModal()">Close</button>
      </div>
    </div>
  </div>
</div>

</body>
<script>
    let cart = [];

    function resetFields() {
    // Reset payment and change fields
    document.getElementById("payment-amount").value = '';
    document.getElementById("change").value = '';
    document.getElementById("quantity").value = '';
    document.getElementById("product_id").value = '';
}

function processPayment() {
    const totalAmount = parseFloat(document.getElementById("totalAmount").textContent);
    const payment = parseFloat(document.getElementById("payment").value);
    const changeField = document.getElementById("change");

    // Check if payment is enough
    if (payment >= totalAmount) {
        // Calculate change
        const change = payment - totalAmount;
        changeField.value = change.toFixed(2);

        // Reset fields after payment
        resetFields();
    } else {
         // Show warning modal if payment is insufficient
        showModal();
    }
}

    function showModalSuccessful() {
    // Display the modal
    document.getElementById("successModal").style.display = "flex";  // Use flex to center it
}

function successModal() {
    // Close the modal
    document.getElementById("successModal").style.display = "none";
}

function showModal() {
    // Display the modal
    document.getElementById("warningModal").style.display = "flex";  // Use flex to center it
}

function closeModal() {
    // Close the modal
    document.getElementById("warningModal").style.display = "none";
}


 // Add product to cart and update button text
function addToCart(product) {
    const existingProduct = cart.find(item => item.product_id === product.product_id);
    if (existingProduct) {
        existingProduct.quantity += 1;
    } else {
        cart.push({ ...product, quantity: 1 });
    }
    updateCartDisplay();

    // Automatically populate the product_id and quantity in the form
    document.getElementById("product_id").value = product.product_id;
    document.getElementById("quantity").value = cart.find(item => item.product_id === product.product_id).quantity;

    // Check stock and update button text
    const addToCartButton = document.getElementById('add-to-cart-btn-${product.product_id}');
    if (product.stock === 0) {
        addToCartButton.textContent = "Out of Stock";
        addToCartButton.disabled = true; // Disable button when out of stock
         addToCartButton.classList.add('out-of-stock');
    } else {
        addToCartButton.textContent = "Add to Cart";
        addToCartButton.disabled = false; // Enable button when stock is available
    }
}
function enableOrDisablePayButton(total) {
            const paymentAmountInput = document.getElementById('payment-amount');
            const payButton = document.getElementById('pay-btn');
            const changeField = document.getElementById('change');

            paymentAmountInput.addEventListener('input', () => {
                const paymentAmount = parseFloat(paymentAmountInput.value);
                if (isNaN(paymentAmount) || paymentAmount === 0) {
                    payButton.disabled = true;
                    changeField.value = '';
                } else if (paymentAmount < total) {
                    payButton.disabled = true;
                    changeField.value = 'Insufficient amount';
                } else if (paymentAmount === total) {
                    payButton.disabled = false;
                    changeField.value = (paymentAmount - total).toFixed(2);
                } else {
                    payButton.disabled = false;
                    changeField.value = (paymentAmount - total).toFixed(2);
                }
            });
        }

        // Handle Pay button click
        document.getElementById('pay-btn').addEventListener('click', () => {
            const paymentAmount = parseFloat(document.getElementById('payment-amount').value);
            const totalAmount = parseFloat(document.getElementById('cart-total').textContent);
            const changeField = document.getElementById('change');

            if (paymentAmount < totalAmount) {
                alert('Insufficient amount. Please enter a sufficient payment amount.');
            } else if (paymentAmount >= totalAmount) {
                // Implement purchase logic here (e.g., create order in backend)
                cart = [];  // Clear cart
                updateCartDisplay();  // Refresh cart view
            }
        });

function placeOrder() {
    const product_id = document.getElementById("product_id").value;
    const quantity = document.getElementById("quantity").value;
    const customer_name = document.getElementById("customer_name").value;
    const customer_email = document.getElementById("customer_email").value;

    const orderData = {
        product_id: product_id,
        quantity: quantity,
        customer_name: customer_name,
        customer_email: customer_email
    };

    fetch('/buy_product', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showModalSuccessful();
            resetFields();
        } else if (data.error) {
            showModal();
            resetFields();
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong!");
    });
}

function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalElement = document.getElementById('cart-total');
            cartItemsContainer.innerHTML = '';

            let total = 0;

            cart.forEach(item => {
                total += item.price * item.quantity;
                const row = document.createElement('tr');
                const productCell = document.createElement('td');
                productCell.textContent = item.name;
                const quantityCell = document.createElement('td');
                quantityCell.textContent = item.quantity;
                const priceCell = document.createElement('td');
                priceCell.textContent = `$${(item.price * item.quantity).toFixed(2)}`;
                const actionCell = document.createElement('td');
                const removeButton = document.createElement('span');
                removeButton.textContent = 'Remove';
                removeButton.addEventListener('click', () => {
                    removeFromCart(item.product_id);
                    resetFields();
                });
                actionCell.appendChild(removeButton);
                row.appendChild(productCell);
                row.appendChild(quantityCell);
                row.appendChild(priceCell);
                row.appendChild(actionCell);
                cartItemsContainer.appendChild(row);
            });

            cartTotalElement.textContent = total.toFixed(2);
            enableOrDisablePayButton(total);
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.product_id !== productId);
            updateCartDisplay();
        }

     fetch('/get_products')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('products-container');
        container.innerHTML = ''; // Clear existing content

        data.products.forEach(product => {
            // Create product card
            const productCard = document.createElement('div');
            productCard.classList.add('product');

            // Product image
            const img = document.createElement('img');
            img.src = `data:image/png;base64,${product.product_image}`;
            img.alt = product.name;

            // Product name
            const name = document.createElement('p');
            name.textContent = product.name;

            // Product price
            const price = document.createElement('p');
            price.textContent = `$${product.price.toFixed(2)}`;

            const stock = document.createElement('p');
            stock.textContent = `Available Stock : ${product.stock}`;

            // Add to Cart Button
            const addToCartButton = document.createElement('button');
            addToCartButton.classList.add('add-to-cart');
            addToCartButton.dataset.id = product.product_id; // Store product_id
            addToCartButton.dataset.name = product.name; // Store product name
            addToCartButton.dataset.price = product.price; // Store product price
            addToCartButton.dataset.image = product.product_image; // Store product image as Base64

            // Check stock and update button text
            if (product.stock <= 0) {
                addToCartButton.textContent = 'Out of Stock';
                addToCartButton.disabled = true;
                 addToCartButton.classList.add('out-of-stock');
            } else {
                addToCartButton.textContent = 'Add to Cart';
                addToCartButton.disabled = false;

                // Add click event to the button
                addToCartButton.addEventListener('click', () => {
                    addToCart(product);
                });
            }

            // Append elements to product card
            productCard.appendChild(img);
            productCard.appendChild(name);
            productCard.appendChild(price);
            productCard.appendChild(stock);
            productCard.appendChild(addToCartButton);

            // Append product card to container
            container.appendChild(productCard);
        });
    })
    .catch(error => console.error('Error fetching products:', error));

        // Fetch and display categories
    fetch('/get_categories')
        .then(response => response.json())
        .then(data => {
            const categoriesContainer = document.getElementById('categories-container');
            categoriesContainer.innerHTML = ''; // Clear existing content

            data.categories.forEach(category => {
                // Create category button
                const categoryButton = document.createElement('div');
                categoryButton.classList.add('category');
                categoryButton.textContent = category.name;
                categoryButton.dataset.id = category.category_id; // Store category_id in data attribute

                // Add click event to fetch products for this category
                categoryButton.addEventListener('click', () => {
                    fetchProducts(category.category_id);
                });

                // Append category button to container
                categoriesContainer.appendChild(categoryButton);
            });
        })
        .catch(error => console.error('Error fetching categories:', error));

    function fetchProducts(categoryId) {
    const url = categoryId ? `/get_products?category_id=${categoryId}` : '/get_products';

    fetch(url)
        .then(response => response.json())
        .then(data => {
            const productsContainer = document.getElementById('products-container');
            productsContainer.innerHTML = ''; // Clear existing content

            data.products.forEach(product => {
                // Create product card
                const productCard = document.createElement('div');
                productCard.classList.add('product');

                // Product image
                const img = document.createElement('img');
                img.src = `data:image/png;base64,${product.product_image}`;
                img.alt = product.name;

                // Product name
                const name = document.createElement('p');
                name.textContent = product.name;

                // Product price
                const price = document.createElement('p');
                price.textContent = `$${product.price.toFixed(2)}`;

                const stock = document.createElement('p');
                stock.textContent = `Available Stock : ${product.stock}`;

                // Add to Cart Button
                const addToCartButton = document.createElement('button');
                addToCartButton.textContent = 'Add to Cart';
                addToCartButton.classList.add('add-to-cart');
                addToCartButton.dataset.id = product.product_id; // Store product_id
                addToCartButton.dataset.name = product.name; // Store product name
                addToCartButton.dataset.price = product.price; // Store product price
                addToCartButton.dataset.image = product.product_image; // Store product image as Base64

                // Check stock and update button text
                if (product.stock <= 0) {
                    addToCartButton.textContent = 'Out of Stock';
                    addToCartButton.disabled = true;
                     addToCartButton.classList.add('out-of-stock');
                } else {
                    addToCartButton.textContent = 'Add to Cart';
                    addToCartButton.disabled = false;

                    // Add click event to the button
                    addToCartButton.addEventListener('click', () => {
                        addToCart(product);
                    });
                }

                // Add click event to the button
                addToCartButton.addEventListener('click', () => {
                    addToCart(product);
                });

                // Append elements to product card
                productCard.appendChild(img);
                productCard.appendChild(name);
                productCard.appendChild(price);
                 productCard.appendChild(stock);
                productCard.appendChild(addToCartButton);

                // Append product card to container
                productsContainer.appendChild(productCard);
            });
        })
        .catch(error => console.error('Error fetching products:', error));
}
    </script>
</html>
